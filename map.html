




<!doctype html>
<html lang="zh-cn" class="map-page">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>地震离你有多近？</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="css/map.css">
    <link rel="stylesheet" href="https://maps.openquake.org/static/css/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://maps.openquake.org/static/css/dist/leaflet.control.geocoder.css"/>
    <link rel="stylesheet" href="https://maps.openquake.org/static/css/dist/leaflet.measure.css"/>
    <link rel="stylesheet" href="https://maps.openquake.org/static/css/dist/leaflet.control.htmllegend.css"/>

  </head>
  <body class="bg-dark">
    <div class="container-fluid h-100 d-flex flex-column">

      <main class="row">
        <div class="h-100 map-container flex-fill">
          <div class="container-fluid h-100">
            <div class="row h-100" id="map-container">
              <div class="col w-100" id="map"></div>

            </div>
          </div>
        </div>
        <div class="page-container" id="page-container">
            <div id="page-subtitle" class="page-subtitle-container">
                <span id="subtitle" class="subtitle">该地点可能会发生约</span>
                <span id="numberCap" class="numberCap">里氏 </span>
                <span id="number" class="number">6.8</span>
                <span id="numberCap" class="numberCap"> 级地震*</span>
                <span id="caption" class="caption">*不用恐慌，推测数据</span>
                <div id="locationInfo">
                <span id="locationLogo" class="locationLogo"></span>
                <span id="locationName" class="locationName">北京市</span></div>
            </div>
        </div>
      </main>
    </div>


    <script src="https://maps.openquake.org/static/js/dist/jquery.min.js"></script>
    <script src="https://maps.openquake.org/static/js/dist/bootstrap.bundle.min.js"></script>
    <script src="https://maps.openquake.org/static/js/dist/download.min.js"></script>
    <script src="https://maps.openquake.org/static/js/dist/chart.min.js"></script>
    <script src="https://maps.openquake.org/static/js/dist/leaflet.js"></script>
    <script src="https://maps.openquake.org/static/js/dist/leaflet.singleclick.js"></script>
    <script src="https://maps.openquake.org/static/js/dist/leaflet.fullscreen.min.js"></script>
    <script src="https://maps.openquake.org/static/js/dist/leaflet.styledlayercontrol.js"></script>
    <script src="https://maps.openquake.org/static/js/dist/leaflet.hash.js"></script>
    <script src="https://maps.openquake.org/static/js/dist/leaflet.measure.min.js"></script>
    <script src="https://maps.openquake.org/static/js/dist/leaflet.zoomhome.min.js"></script>
    <script src="https://maps.openquake.org/static/js/dist/leaflet.wms.js"></script>
    <script src="https://maps.openquake.org/static/js/dist/leaflet.control.htmllegend.js"></script>
    <script src="https://maps.openquake.org/static/js/dist/leaflet.control.geocoder.js"></script>
    <script src="https://maps.openquake.org/static/js/dist/leaflet.easy-button.js"></script>
    <script src="https://maps.openquake.org/static/js/dist/leaflet.areaselect.js"></script>
    <script src="https://maps.openquake.org/static/js/dist/leaflet.select.js"></script>
    <script type="text/javascript" src="js/myGeojson.js"></script>
    <script src="js/XmltoJson.js"></script>
    <script src="js/earthquakeCalculater.js"></script>



    <script>
      var MAPSLUG = "global-seismic-hazard-map",
          MAPPROJECT = "ghm",
          collapsed = (L.Browser.android || L.Browser.mobile || L.Browser.retina),
          gfiMarker;

      var infoContainer = $( "#info-container" ),
          dataContainer = $( "#data" ),
          dataDiv = $( "#data-div" );

      $(document).ready(function(){
          $('[data-toggle="tooltip"]').tooltip();
      });
      // Async signals
      infoContainer.on('shown.bs.collapse', function() {
          map.invalidateSize();
      });
      infoContainer.on('hidden.bs.collapse', function() {
          map.invalidateSize();
          sidebarReset();
      });
      function filterTileLayers(property) {
          var layers = [];
          map.eachLayer(function(layer) {
              if( layer instanceof L.TileLayer ) {
                  if (property) {
                      if (layer.options.hasOwnProperty(property)) {
                          if (layer.options[property]) {
                              layers.push(layer.options.name);
                          }
                      }
                  } else {
                      layers.push(layer.options.name);
                  }
              }
          });
          return layers;
      }


      //数据调用
      function display(info) {
          console.log(info);
        $("#number").text(info.seismiCity);
      };

      function WMSGenerator(x) {
         var crs = map.options.crs;
         var bounds = x;
         var size = map.getSize();
         var nw = crs.project(bounds.getNorthWest());
         var se = crs.project(bounds.getSouthEast());
         var params = {
              'width': size.x,
              'height': size.y
         };
         params.bbox = ([nw.x, se.y, se.x, nw.y]).join(',');

         return params;
      }

      function GetFeatureInfo(e,f) {
          var wms = WMSGenerator(f);
          params = {
              width: wms.width,
              height: wms.height,
              bbox: wms.bbox,
              layers: filterTileLayers('ext').toString(),
              x: Math.round(e.x),
              y: Math.round(e.y),
              format: 'text/xml'
          };
        //  var testData = d3.tsv("https://maps.openquake.org/api/project/ghm/getfeatureinfo?width="+params.width+"&height="+params.height+"&bbox="+params.bbox+"&layers=Seismic%20Hazard%20PGA%20(g)&x="+params.x+"&y="+params.y+"&format=text%2Fxml")
        // testData.then (function (s) {
        //   console.log(s[1]);
        // });

          // getXML('https://maps.openquake.org/api/project/' + MAPPROJECT + '/getfeatureinfo' + '?callback=jQuery32109686527416782296_1555211599210&width=372&height=556&bbox=12737466.393441772%2C4562984.840511884%2C13192419.58579514%2C5242968.644136811&layers=Seismic%20Hazard%20PGA%20(g)&x=186&y=278&format=text%2Fxml&_=1555211599211',
          //   function(response)
          //   {
          //   	console.log(response.responseText);
          //   }
          // )

          $.ajax({
          type: "GET",
              url: 'https://maps.openquake.org/api/project/' + MAPPROJECT + '/getfeatureinfo' ,
              data: params,
              dataType: 'xml',
              success: function(data) {
                var pga = $(data).find("Attribute").attr("value");
                var earthquakeResult = earthquakeCal (pga);
                display(earthquakeResult);
              },
              fail: function(data){
                  alert('Unable to load WMS data');
              }
          });
      }
    </script>

    <script>
      // general map
      var bounds =  [[-80.0, -180.0],
                     [80.0, 180.0]];
      var map = L.map('map', {
          fullscreenControl: false,
          center: ['40', '120'],
          zoom: 4,
          zoomControl: false,
          maxZoom: 4,
          minZoom: 4,
          singleClickTimeout: 250
      });

      // zoom

      // var zoomHome = L.Control.zoomHome({
      //     zoomHomeIcon: 'undo',
      //     zoomHomeTitle: 'Reset view',
      // }).addTo(map);


      var hash = new L.Hash(map);

      // var showSidebar = L.easyButton('<i class="fas fa-info"></i>', function(){
      //     infoContainer.collapse("toggle");
      // }).addTo(map);

      // scale

      // L.control.scale().addTo(map);


      // logo

      // map.attributionControl.addAttribution('M. Pagani et al.');

      // geocoder搜索框

      var geocoder = L.Control.geocoder({
              defaultMarkGeocode: true,
              collapsed: false,
              placeholder: "输入地址，看看地震离你有多近",
              errorMessage: "没有找到你的城市",
              showResultIcons: true,
              suggestMinLength: 1
          })
          geocoder.on('markgeocode', function(e) {
              var pointLatLng = e.geocode.center
              var mapLocation = map.latLngToContainerPoint(pointLatLng)
              var mapBbox = e.geocode.bbox
              GetFeatureInfo(mapLocation, mapBbox);})

              // var poly = L.polygon([
              //      bbox.getSouthEast(),
              //      bbox.getNorthEast(),
              //      bbox.getNorthWest(),
              //      bbox.getSouthWest()
              // ]).addTo(map);
              // map.fitBounds(poly.getBounds());
          .addTo(map);

      //BaseLayer;
      var layer_e7d85370 = L.tileLayer('https://maps.openquake.org/mapproxy/ne/wmts/natural-earth-gray/webmercator/{z}/{x}/{y}.png', {
          // trick: expose name via options, used in events
          name: 'Natural Earth (gray)',
          attribution: '<a href=\"https://www.naturalearthdata.com/\" target=\"_blank\">Natural Earth</a>',
           maxZoom: 4,
           minZoom: 4,
      });
      layer_e7d85370.addTo(map);

      var baseLayers = [{
          groupName: "Base maps",
          expanded: false,
          layers: {

              "Natural Earth (gray)": layer_e7d85370,

      }}];

      // overlay layers
      var printableLayers = [];


      L.tileLayer('https://maps.openquake.org/watermark/gem-white/{z}/{x}/{y}.png', {
          name: 'GEM white',
          opacity: 0.1,
          zIndex: 100000,
      }).addTo(map);

      var myStyle = {
                  "color": "#550000",
                  "weight": 1,
                  "opacity": 0.5

              };

      //地震带图
      var layer_seam = L.geoJSON(myGeojsonData,{style:myStyle})
      layer_seam.addTo(map);

      // var layer_earthquake = L.geoJSON("data/gem_active_faults.geojson",{
      //   // filter: function(feature){ return feature.geometry.show_on_map;},
      //   style: myStyle})
      //   console.log(layer_earthquake);
      // layer_earthquake.addTo(map);








      var layer_f883bee1 = L.tileLayer('https://maps.openquake.org/mapproxy/ghm/wmts/shaded-relief/webmercator/{z}/{x}/{y}.png', {
          // trick: expose name via options, used in events
          name: 'Shaded Relief',
          overlay: true,
          attribution: '',
          legend: false,
          printable: true,
          zIndex:9997,
          ext: '',

          maxZoom: 15,
          minZoom: 2,
      });


      var layer_d8644989 = L.tileLayer('https://maps.openquake.org/mapproxy/ghm/wmts/seismic-hazard-pga-g/webmercator/{z}/{x}/{y}.png', {
          // trick: expose name via options, used in events
          name: 'Seismic Hazard PGA (g)',
          overlay: true,
          attribution: '',
          legend: true,
          printable: true,
          zIndex:9996,
          ext: 'js/global-hazard.js',

          maxZoom: 15,
          minZoom: 2,
      });


      var groupedOverlays = [

      { groupName: "Layers",
        expanded: true,
        layers: {


          "Shaded Relief": layer_f883bee1,},
      }];

      // var controlOptions = {
      //   container_width: "300px",
      //   container_maxHeight: "350px",
      //   exclusive: false,
      //   autoZIndex: false,
      //   collapsed: collapsed,
      // };
      // L.Control.styledLayerControl(baseLayers, groupedOverlays, controlOptions).addTo(map);




      layer_f883bee1.addTo(map);

      printableLayers.push('Shaded Relief');

      layer_d8644989.addTo(map);

      printableLayers.push('Seismic Hazard PGA (g)');


      var legendIsCustom = false;

      // selector events
      //设置不可点
      // map.on('singleclick', GetFeatureInfo);

      // map.on('baselayerchange', function (e) {
      //     activeBaseLayer = e.layer.options.name;
      // });
      // map.on('layeradd', function (e) {
      //     if (!(e.layer instanceof L.Marker)) {
      //         if (! legendIsCustom) { updateLegend(legend); }
      //     }
      // });
      // map.on('layerremove', function (e) {
      //     // Close sidebar on a layer removal, but not for the marker
      //     if (!(e.layer instanceof L.Marker)) {
      //         displayClose();
      //         if (! legendIsCustom) { updateLegend(legend); }
      //     }
      // });
    </script>


    <!-- <script>
      legend = L.control.htmllegend({
          position: 'bottomright',
          legends: [{
              name: '图例',
              elements: [{
                  html: '<div id="wmsLegend"><i class="fa fa-spinner fa-spin" style="font-size:24px"></i> 载入图例中……</div>'
              }],
          }],
          collapsedOnInit: collapsed,
      });
      updateLegend(legend, legendIsCustom);
    </script> -->


        <!-- Global site tag (gtag.js) - Google Analytics -->
    <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=UA-130189387-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

    gtag('config', 'UA-130189387-1');
    </script> -->

  </body>
</html>
